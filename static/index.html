<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mantis Power Flow</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --border: #2a2d3e;
    --accent: #4f8ef7;
    --accent-hover: #6fa5ff;
    --text: #e0e4f0;
    --text-dim: #7a7f9a;
    --danger: #e05c5c;
    --success: #4caf80;
    --warn: #e09b3d;
  }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; font-size: 14px; height: 100vh; display: flex; flex-direction: column; }
  header { display: flex; align-items: center; gap: 12px; padding: 0 20px; height: 52px; background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  header h1 { font-size: 18px; font-weight: 600; color: var(--accent); }
  header .case-info { color: var(--text-dim); font-size: 12px; margin-left: auto; }
  .layout { display: flex; flex: 1; overflow: hidden; }

  /* Sidebar */
  aside { width: 180px; flex-shrink: 0; background: var(--surface); border-right: 1px solid var(--border); padding: 16px 12px; display: flex; flex-direction: column; gap: 8px; }
  aside .section-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim); margin-top: 8px; margin-bottom: 2px; }
  aside .section-label:first-child { margin-top: 0; }
  .btn { display: block; width: 100%; padding: 8px 12px; background: var(--border); color: var(--text); border: 1px solid transparent; border-radius: 6px; cursor: pointer; font-size: 13px; text-align: left; transition: background 0.15s, border-color 0.15s; }
  .btn:hover { background: #333654; border-color: var(--accent); }
  .btn.primary { background: var(--accent); color: #fff; }
  .btn.primary:hover { background: var(--accent-hover); }
  .btn.danger { background: transparent; color: var(--danger); border-color: var(--danger); }
  .btn.danger:hover { background: rgba(224,92,92,0.1); }
  .btn.small { padding: 4px 8px; font-size: 12px; width: auto; display: inline-block; }

  /* Main */
  main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  /* Tabs */
  .tabs { display: flex; gap: 2px; padding: 10px 16px 0; background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .tab { padding: 8px 18px; border-radius: 6px 6px 0 0; cursor: pointer; color: var(--text-dim); border: 1px solid transparent; border-bottom: none; font-size: 13px; transition: color 0.15s, background 0.15s; }
  .tab:hover { color: var(--text); }
  .tab.active { background: var(--bg); color: var(--accent); border-color: var(--border); border-bottom-color: var(--bg); }

  /* Content */
  .content { flex: 1; overflow: auto; padding: 20px; }
  .content h2 { font-size: 15px; margin-bottom: 14px; color: var(--text-dim); font-weight: 500; }
  .toolbar { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; }

  /* Table */
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { background: var(--surface); color: var(--text-dim); font-weight: 500; text-align: left; padding: 8px 10px; border-bottom: 1px solid var(--border); font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
  td { padding: 7px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:hover td { background: rgba(79,142,247,0.04); }
  .tag { display: inline-block; padding: 2px 7px; border-radius: 4px; font-size: 11px; font-weight: 600; }
  .tag.slack { background: rgba(79,142,247,0.2); color: var(--accent); }
  .tag.pq { background: rgba(76,175,128,0.2); color: var(--success); }
  .tag.pv { background: rgba(224,155,61,0.2); color: var(--warn); }
  .tag.oos { background: rgba(224,92,92,0.15); color: var(--danger); }
  .tag.line { background: rgba(79,142,247,0.15); color: var(--accent); }
  .tag.xfmr { background: rgba(224,155,61,0.15); color: var(--warn); }
  .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; }
  .status-dot.on { background: var(--success); }
  .status-dot.off { background: var(--danger); }
  .actions { display: flex; gap: 4px; }
  .empty-msg { color: var(--text-dim); text-align: center; padding: 40px 0; }
  .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .results-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .results-card h3 { font-size: 13px; color: var(--text-dim); margin-bottom: 12px; font-weight: 500; }
  .no-results { color: var(--text-dim); text-align: center; padding: 60px 0; }

  /* Modal */
  dialog { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 0; width: 520px; max-width: 95vw; color: var(--text); box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
  dialog::backdrop { background: rgba(0,0,0,0.6); }
  .modal-header { padding: 18px 20px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .modal-header h3 { font-size: 15px; }
  .modal-close { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 20px; line-height: 1; padding: 0 4px; }
  .modal-close:hover { color: var(--text); }
  .modal-body { padding: 16px 20px; max-height: 70vh; overflow-y: auto; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 16px; }
  .form-group { display: flex; flex-direction: column; gap: 4px; }
  .form-group.full { grid-column: 1 / -1; }
  label { font-size: 12px; color: var(--text-dim); }
  input, select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 7px 10px; border-radius: 6px; font-size: 13px; width: 100%; transition: border-color 0.15s; }
  input:focus, select:focus { outline: none; border-color: var(--accent); }
  input[type=checkbox] { width: auto; }
  .form-check { display: flex; align-items: center; gap: 8px; }
  .form-check label { color: var(--text); font-size: 13px; }
  .modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }

  /* Toast */
  #toast { position: fixed; bottom: 20px; right: 20px; padding: 10px 18px; border-radius: 8px; font-size: 13px; z-index: 9999; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
  #toast.show { opacity: 1; }
  #toast.ok { background: var(--success); color: #fff; }
  #toast.err { background: var(--danger); color: #fff; }
</style>
</head>
<body>

<header>
  <h1>⚡ Mantis Power Flow</h1>
  <span class="case-info" id="caseInfo">No case loaded</span>
</header>

<div class="layout">
  <aside>
    <span class="section-label">Case</span>
    <button class="btn primary" onclick="triggerUpload()">Upload RAW</button>
    <button class="btn" onclick="promptNewCase()">New Case</button>
    <input type="file" id="fileInput" accept=".raw,.RAW" style="display:none" onchange="uploadFile(event)">

    <span class="section-label">Analysis</span>
    <button class="btn" onclick="solveDC()">Solve DC</button>

    <span class="section-label">Export</span>
    <button class="btn" onclick="exportRaw()">Export RAW</button>
  </aside>

  <main>
    <div class="tabs">
      <div class="tab active" data-tab="buses" onclick="switchTab('buses')">Buses</div>
      <div class="tab" data-tab="branches" onclick="switchTab('branches')">Branches</div>
      <div class="tab" data-tab="generators" onclick="switchTab('generators')">Generators</div>
      <div class="tab" data-tab="loads" onclick="switchTab('loads')">Loads</div>
      <div class="tab" data-tab="results" onclick="switchTab('results')">Results</div>
    </div>
    <div class="content" id="content">
      <div class="empty-msg">Upload a RAW file or create a new case to get started.</div>
    </div>
  </main>
</div>

<!-- Edit/Add Modal -->
<dialog id="modal">
  <div class="modal-header">
    <h3 id="modalTitle">Edit</h3>
    <button class="modal-close" onclick="closeModal()">×</button>
  </div>
  <div class="modal-body" id="modalBody"></div>
  <div class="modal-footer">
    <button class="btn" onclick="closeModal()">Cancel</button>
    <button class="btn primary" onclick="saveModal()">Save</button>
  </div>
</dialog>

<div id="toast"></div>

<script>
let state = null;         // current Network object
let dcSolution = null;    // last DC solve result
let currentTab = 'buses';
let modalMode = null;     // { type, id } or { type, add: true }

// ─── Utilities ──────────────────────────────────────────────────────────────

async function api(method, path, body) {
  const opts = { method, headers: {} };
  if (body !== undefined) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(body);
  }
  const res = await fetch(path, opts);
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); } catch { data = text; }
  return { ok: res.ok, status: res.status, data };
}

function toast(msg, type = 'ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show ' + type;
  clearTimeout(el._timer);
  el._timer = setTimeout(() => el.className = '', 3000);
}

function fmt(v, decimals = 3) {
  if (v === null || v === undefined) return '-';
  return Number(v).toFixed(decimals);
}

// ─── State / Render ──────────────────────────────────────────────────────────

function updateCaseInfo() {
  const el = document.getElementById('caseInfo');
  if (!state) { el.textContent = 'No case loaded'; return; }
  el.textContent = `${state.case_name} | Sbase: ${state.s_base} MVA | ${state.frequency} Hz | ${state.buses.length} buses, ${state.branches.length} branches`;
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.dataset.tab === tab);
  });
  renderContent();
}

function renderContent() {
  const el = document.getElementById('content');
  if (!state) {
    el.innerHTML = '<div class="empty-msg">Upload a RAW file or create a new case to get started.</div>';
    return;
  }
  switch (currentTab) {
    case 'buses':     el.innerHTML = renderBuses(); break;
    case 'branches':  el.innerHTML = renderBranches(); break;
    case 'generators':el.innerHTML = renderGenerators(); break;
    case 'loads':     el.innerHTML = renderLoads(); break;
    case 'results':   el.innerHTML = renderResults(); break;
  }
}

// ─── Buses ───────────────────────────────────────────────────────────────────

function busTypeTag(t) {
  const cls = { Slack: 'slack', PQ: 'pq', PV: 'pv', OOS: 'oos' }[t] || '';
  return `<span class="tag ${cls}">${t}</span>`;
}

function renderBuses() {
  const rows = state.buses.map(b => `
    <tr>
      <td>${b.bus_id}</td>
      <td>${b.bus_name}</td>
      <td>${busTypeTag(b.bus_type)}</td>
      <td>${fmt(b.nom_voltage, 1)} kV</td>
      <td>${fmt(b.voltage, 4)}</td>
      <td>${fmt(b.angle, 4)}°</td>
      <td><span class="status-dot ${b.bus_status ? 'on' : 'off'}"></span></td>
      <td class="actions">
        <button class="btn small" onclick="openEdit('bus', ${b.bus_id})">Edit</button>
        <button class="btn small danger" onclick="deleteBus(${b.bus_id})">Del</button>
      </td>
    </tr>`).join('');
  return `
    <div class="toolbar">
      <h2>Buses (${state.buses.length})</h2>
      <button class="btn small primary" onclick="openAdd('bus')">+ Add Bus</button>
    </div>
    <table>
      <thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Nom kV</th><th>|V| pu</th><th>Angle</th><th>In Svc</th><th>Actions</th></tr></thead>
      <tbody>${rows || '<tr><td colspan="8" class="empty-msg">No buses</td></tr>'}</tbody>
    </table>`;
}

// ─── Branches ────────────────────────────────────────────────────────────────

function renderBranches() {
  const rows = state.branches.map(b => `
    <tr>
      <td>${b.id}</td>
      <td>${b.from_bus} → ${b.to_bus}</td>
      <td><span class="tag ${b.branch_type === 'Line' ? 'line' : 'xfmr'}">${b.branch_type}</span></td>
      <td>${fmt(b.resistance, 5)}</td>
      <td>${fmt(b.reactance, 5)}</td>
      <td>${fmt(b.tap_ratio, 4)}</td>
      <td>${fmt(b.operating_limit, 0)} MW</td>
      <td><span class="status-dot ${b.branch_status ? 'on' : 'off'}"></span></td>
      <td class="actions">
        <button class="btn small" onclick="openEdit('branch', ${b.id})">Edit</button>
        <button class="btn small danger" onclick="deleteBranch(${b.id})">Del</button>
      </td>
    </tr>`).join('');
  return `
    <div class="toolbar">
      <h2>Branches (${state.branches.length})</h2>
      <button class="btn small primary" onclick="openAdd('branch')">+ Add Branch</button>
    </div>
    <table>
      <thead><tr><th>ID</th><th>From→To</th><th>Type</th><th>R (pu)</th><th>X (pu)</th><th>Tap</th><th>Rate A</th><th>In Svc</th><th>Actions</th></tr></thead>
      <tbody>${rows || '<tr><td colspan="9" class="empty-msg">No branches</td></tr>'}</tbody>
    </table>`;
}

// ─── Generators ──────────────────────────────────────────────────────────────

function renderGenerators() {
  const rows = state.generators.map(g => `
    <tr>
      <td>${g.gen_id}</td>
      <td>${g.gen_bus_id}</td>
      <td>${g.gen_name}</td>
      <td>${fmt(g.p_gen, 1)} MW</td>
      <td>${fmt(g.q_gen, 1)} MVAR</td>
      <td>${fmt(g.v_setpoint, 4)}</td>
      <td>${fmt(g.p_min, 0)} / ${fmt(g.p_max, 0)}</td>
      <td><span class="status-dot ${g.gen_status ? 'on' : 'off'}"></span></td>
      <td class="actions">
        <button class="btn small" onclick="openEdit('generator', ${g.gen_id})">Edit</button>
        <button class="btn small danger" onclick="deleteGenerator(${g.gen_id})">Del</button>
      </td>
    </tr>`).join('');
  return `
    <div class="toolbar">
      <h2>Generators (${state.generators.length})</h2>
      <button class="btn small primary" onclick="openAdd('generator')">+ Add Generator</button>
    </div>
    <table>
      <thead><tr><th>ID</th><th>Bus</th><th>Name</th><th>P</th><th>Q</th><th>Vset</th><th>Pmin/Pmax</th><th>In Svc</th><th>Actions</th></tr></thead>
      <tbody>${rows || '<tr><td colspan="9" class="empty-msg">No generators</td></tr>'}</tbody>
    </table>`;
}

// ─── Loads ───────────────────────────────────────────────────────────────────

function renderLoads() {
  const rows = state.loads.map(l => `
    <tr>
      <td>${l.load_id}</td>
      <td>${l.bus_id}</td>
      <td>${l.load_name}</td>
      <td>${fmt(l.real_load, 1)} MW</td>
      <td>${fmt(l.imag_load, 1)} MVAR</td>
      <td class="actions">
        <button class="btn small" onclick="openEdit('load', ${l.load_id})">Edit</button>
        <button class="btn small danger" onclick="deleteLoad(${l.load_id})">Del</button>
      </td>
    </tr>`).join('');
  return `
    <div class="toolbar">
      <h2>Loads (${state.loads.length})</h2>
      <button class="btn small primary" onclick="openAdd('load')">+ Add Load</button>
    </div>
    <table>
      <thead><tr><th>ID</th><th>Bus</th><th>Name</th><th>P (MW)</th><th>Q (MVAR)</th><th>Actions</th></tr></thead>
      <tbody>${rows || '<tr><td colspan="6" class="empty-msg">No loads</td></tr>'}</tbody>
    </table>`;
}

// ─── Results ─────────────────────────────────────────────────────────────────

function renderResults() {
  if (!dcSolution) {
    return '<div class="no-results">No DC solution yet. Click <strong>Solve DC</strong> in the sidebar.</div>';
  }
  const angles = Object.entries(dcSolution.bus_angles)
    .sort((a, b) => Number(a[0]) - Number(b[0]))
    .map(([id, ang]) => `<tr><td>${id}</td><td>${fmt(ang, 4)}°</td></tr>`).join('');

  const flows = Object.entries(dcSolution.branch_flows)
    .sort((a, b) => Number(a[0]) - Number(b[0]))
    .map(([id, mw]) => {
      const branch = state.branches.find(b => b.id === Number(id));
      const label = branch ? `${branch.from_bus}→${branch.to_bus}` : id;
      return `<tr><td>${id}</td><td>${label}</td><td>${fmt(mw, 2)} MW</td></tr>`;
    }).join('');

  return `
    <div class="results-grid">
      <div class="results-card">
        <h3>Bus Voltage Angles</h3>
        <table>
          <thead><tr><th>Bus ID</th><th>Angle (deg)</th></tr></thead>
          <tbody>${angles}</tbody>
        </table>
      </div>
      <div class="results-card">
        <h3>Branch MW Flows</h3>
        <table>
          <thead><tr><th>Branch ID</th><th>From→To</th><th>Flow</th></tr></thead>
          <tbody>${flows}</tbody>
        </table>
      </div>
    </div>`;
}

// ─── Upload / New Case ───────────────────────────────────────────────────────

function triggerUpload() {
  document.getElementById('fileInput').click();
}

async function uploadFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const fd = new FormData();
  fd.append('file', file);
  const res = await fetch('/api/upload', { method: 'POST', body: fd });
  const data = await res.json();
  if (res.ok) {
    state = data;
    dcSolution = null;
    updateCaseInfo();
    renderContent();
    toast(`Loaded: ${state.case_name}`);
  } else {
    toast(data.error || 'Upload failed', 'err');
  }
  event.target.value = '';
}

async function promptNewCase() {
  const name = prompt('Case name:', 'New Case');
  if (!name) return;
  const sbase = parseFloat(prompt('System MVA base:', '100') || '100');
  const freq = parseFloat(prompt('Frequency (Hz):', '60') || '60');
  const r = await api('POST', '/api/network/new', { case_name: name, s_base: sbase, frequency: freq });
  if (r.ok) {
    state = r.data;
    dcSolution = null;
    updateCaseInfo();
    renderContent();
    toast(`Created: ${state.case_name}`);
  } else {
    toast(r.data.error || 'Failed to create case', 'err');
  }
}

// ─── Solve & Export ───────────────────────────────────────────────────────────

async function solveDC() {
  if (!state) { toast('Load a case first', 'err'); return; }
  const r = await api('POST', '/api/solve/dc');
  if (r.ok) {
    dcSolution = r.data;
    toast('DC solve complete');
    if (currentTab !== 'results') switchTab('results');
    else renderContent();
  } else {
    toast(r.data.error || 'DC solve failed', 'err');
  }
}

function exportRaw() {
  if (!state) { toast('Load a case first', 'err'); return; }
  window.location.href = '/api/export';
}

// ─── Delete ───────────────────────────────────────────────────────────────────

async function deleteBus(id) {
  if (!confirm(`Delete bus ${id} and all connected elements?`)) return;
  const r = await api('DELETE', `/api/buses/${id}`);
  if (r.ok) { await refreshNetwork(); toast(`Bus ${id} deleted`); }
  else toast(r.data.error || 'Delete failed', 'err');
}

async function deleteBranch(id) {
  if (!confirm(`Delete branch ${id}?`)) return;
  const r = await api('DELETE', `/api/branches/${id}`);
  if (r.ok) { await refreshNetwork(); toast(`Branch ${id} deleted`); }
  else toast(r.data.error || 'Delete failed', 'err');
}

async function deleteGenerator(id) {
  if (!confirm(`Delete generator ${id}?`)) return;
  const r = await api('DELETE', `/api/generators/${id}`);
  if (r.ok) { await refreshNetwork(); toast(`Generator ${id} deleted`); }
  else toast(r.data.error || 'Delete failed', 'err');
}

async function deleteLoad(id) {
  if (!confirm(`Delete load ${id}?`)) return;
  const r = await api('DELETE', `/api/loads/${id}`);
  if (r.ok) { await refreshNetwork(); toast(`Load ${id} deleted`); }
  else toast(r.data.error || 'Delete failed', 'err');
}

async function refreshNetwork() {
  const r = await api('GET', '/api/network');
  if (r.ok) { state = r.data; updateCaseInfo(); renderContent(); }
}

// ─── Modal ────────────────────────────────────────────────────────────────────

function openEdit(type, id) {
  let item;
  switch (type) {
    case 'bus':       item = state.buses.find(b => b.bus_id === id); break;
    case 'branch':    item = state.branches.find(b => b.id === id); break;
    case 'generator': item = state.generators.find(g => g.gen_id === id); break;
    case 'load':      item = state.loads.find(l => l.load_id === id); break;
  }
  if (!item) return;
  modalMode = { type, id, add: false };
  document.getElementById('modalTitle').textContent = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}`;
  document.getElementById('modalBody').innerHTML = buildForm(type, item);
  document.getElementById('modal').showModal();
}

function openAdd(type) {
  modalMode = { type, id: null, add: true };
  const defaults = {
    bus: { bus_id: 0, bus_name: 'New Bus', bus_type: 'PQ', nom_voltage: 138.0, bus_status: true, voltage: 1.0, angle: 0.0, real_shunt: 0.0, imag_shunt: 0.0, v_min_operating: 0.9, v_min_contingency: 0.9, v_max_operating: 1.1, v_max_contingency: 1.1 },
    branch: { id: 0, from_bus: 1, to_bus: 2, branch_type: 'Line', branch_name: '', branch_status: true, resistance: 0.01, reactance: 0.1, tap_ratio: 1.0, phase_shift: 0.0, operating_limit: 0.0, contingency_limit: 0.0, from_shunt_conductance: 0.0, from_shunt_susceptance: 0.0, to_shunt_conductance: 0.0, to_shunt_susceptance: 0.0 },
    generator: { gen_id: 0, gen_bus_id: 1, gen_name: 'New Gen', gen_status: true, p_gen: 0.0, q_gen: 0.0, v_setpoint: 1.0, p_min: 0.0, p_max: 100.0, q_min: -50.0, q_max: 50.0 },
    load: { load_id: 0, bus_id: 1, load_name: 'New Load', real_load: 0.0, imag_load: 0.0 },
  };
  document.getElementById('modalTitle').textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
  document.getElementById('modalBody').innerHTML = buildForm(type, defaults[type]);
  document.getElementById('modal').showModal();
}

function closeModal() {
  document.getElementById('modal').close();
  modalMode = null;
}

function buildForm(type, item) {
  switch (type) {
    case 'bus': return `
      <div class="form-grid">
        <div class="form-group"><label>ID</label><input type="number" id="f_bus_id" value="${item.bus_id}" readonly></div>
        <div class="form-group"><label>Name</label><input type="text" id="f_bus_name" value="${item.bus_name}"></div>
        <div class="form-group"><label>Type</label>
          <select id="f_bus_type">
            ${['Slack','PQ','PV','OOS'].map(t => `<option${item.bus_type===t?' selected':''}>${t}</option>`).join('')}
          </select>
        </div>
        <div class="form-group"><label>Nom kV</label><input type="number" id="f_nom_voltage" step="any" value="${item.nom_voltage}"></div>
        <div class="form-group"><label>Voltage (pu)</label><input type="number" id="f_voltage" step="any" value="${item.voltage}"></div>
        <div class="form-group"><label>Angle (deg)</label><input type="number" id="f_angle" step="any" value="${item.angle}"></div>
        <div class="form-group"><label>Vmin op</label><input type="number" id="f_v_min_operating" step="any" value="${item.v_min_operating}"></div>
        <div class="form-group"><label>Vmax op</label><input type="number" id="f_v_max_operating" step="any" value="${item.v_max_operating}"></div>
        <div class="form-group"><label>Vmin cont</label><input type="number" id="f_v_min_contingency" step="any" value="${item.v_min_contingency}"></div>
        <div class="form-group"><label>Vmax cont</label><input type="number" id="f_v_max_contingency" step="any" value="${item.v_max_contingency}"></div>
        <div class="form-group full form-check">
          <input type="checkbox" id="f_bus_status" ${item.bus_status?'checked':''}>
          <label for="f_bus_status">In Service</label>
        </div>
      </div>`;
    case 'branch': return `
      <div class="form-grid">
        <div class="form-group"><label>ID</label><input type="number" id="f_id" value="${item.id}" readonly></div>
        <div class="form-group"><label>Type</label>
          <select id="f_branch_type">
            ${['Line','TwoWinding'].map(t => `<option${item.branch_type===t?' selected':''}>${t}</option>`).join('')}
          </select>
        </div>
        <div class="form-group"><label>From Bus</label><input type="number" id="f_from_bus" value="${item.from_bus}"></div>
        <div class="form-group"><label>To Bus</label><input type="number" id="f_to_bus" value="${item.to_bus}"></div>
        <div class="form-group"><label>R (pu)</label><input type="number" id="f_resistance" step="any" value="${item.resistance}"></div>
        <div class="form-group"><label>X (pu)</label><input type="number" id="f_reactance" step="any" value="${item.reactance}"></div>
        <div class="form-group"><label>Tap Ratio</label><input type="number" id="f_tap_ratio" step="any" value="${item.tap_ratio}"></div>
        <div class="form-group"><label>Phase Shift (deg)</label><input type="number" id="f_phase_shift" step="any" value="${item.phase_shift}"></div>
        <div class="form-group"><label>Rate A (MW)</label><input type="number" id="f_operating_limit" step="any" value="${item.operating_limit}"></div>
        <div class="form-group"><label>Rate B (MW)</label><input type="number" id="f_contingency_limit" step="any" value="${item.contingency_limit}"></div>
        <div class="form-group full form-check">
          <input type="checkbox" id="f_branch_status" ${item.branch_status?'checked':''}>
          <label for="f_branch_status">In Service</label>
        </div>
      </div>`;
    case 'generator': return `
      <div class="form-grid">
        <div class="form-group"><label>ID</label><input type="number" id="f_gen_id" value="${item.gen_id}" readonly></div>
        <div class="form-group"><label>Bus ID</label><input type="number" id="f_gen_bus_id" value="${item.gen_bus_id}"></div>
        <div class="form-group full"><label>Name</label><input type="text" id="f_gen_name" value="${item.gen_name}"></div>
        <div class="form-group"><label>P gen (MW)</label><input type="number" id="f_p_gen" step="any" value="${item.p_gen}"></div>
        <div class="form-group"><label>Q gen (MVAR)</label><input type="number" id="f_q_gen" step="any" value="${item.q_gen}"></div>
        <div class="form-group"><label>V setpoint (pu)</label><input type="number" id="f_v_setpoint" step="any" value="${item.v_setpoint}"></div>
        <div class="form-group"><label>P min (MW)</label><input type="number" id="f_p_min" step="any" value="${item.p_min}"></div>
        <div class="form-group"><label>P max (MW)</label><input type="number" id="f_p_max" step="any" value="${item.p_max}"></div>
        <div class="form-group"><label>Q min (MVAR)</label><input type="number" id="f_q_min" step="any" value="${item.q_min}"></div>
        <div class="form-group"><label>Q max (MVAR)</label><input type="number" id="f_q_max" step="any" value="${item.q_max}"></div>
        <div class="form-group full form-check">
          <input type="checkbox" id="f_gen_status" ${item.gen_status?'checked':''}>
          <label for="f_gen_status">In Service</label>
        </div>
      </div>`;
    case 'load': return `
      <div class="form-grid">
        <div class="form-group"><label>ID</label><input type="number" id="f_load_id" value="${item.load_id}" readonly></div>
        <div class="form-group"><label>Bus ID</label><input type="number" id="f_bus_id" value="${item.bus_id}"></div>
        <div class="form-group full"><label>Name</label><input type="text" id="f_load_name" value="${item.load_name}"></div>
        <div class="form-group"><label>P load (MW)</label><input type="number" id="f_real_load" step="any" value="${item.real_load}"></div>
        <div class="form-group"><label>Q load (MVAR)</label><input type="number" id="f_imag_load" step="any" value="${item.imag_load}"></div>
      </div>`;
    default: return '';
  }
}

function collectForm(type) {
  const g = id => {
    const el = document.getElementById(id);
    if (!el) return undefined;
    if (el.type === 'checkbox') return el.checked;
    if (el.type === 'number') return el.value === '' ? 0 : parseFloat(el.value);
    return el.value;
  };
  switch (type) {
    case 'bus': return {
      bus_id: g('f_bus_id'), bus_name: g('f_bus_name'), bus_type: g('f_bus_type'),
      nom_voltage: g('f_nom_voltage'), voltage: g('f_voltage'), angle: g('f_angle'),
      bus_status: g('f_bus_status'), real_shunt: 0, imag_shunt: 0,
      v_min_operating: g('f_v_min_operating'), v_max_operating: g('f_v_max_operating'),
      v_min_contingency: g('f_v_min_contingency'), v_max_contingency: g('f_v_max_contingency'),
    };
    case 'branch': return {
      id: g('f_id'), branch_type: g('f_branch_type'), from_bus: g('f_from_bus'), to_bus: g('f_to_bus'),
      branch_name: '', branch_status: g('f_branch_status'),
      resistance: g('f_resistance'), reactance: g('f_reactance'),
      tap_ratio: g('f_tap_ratio'), phase_shift: g('f_phase_shift'),
      operating_limit: g('f_operating_limit'), contingency_limit: g('f_contingency_limit'),
      from_shunt_conductance: 0, from_shunt_susceptance: 0,
      to_shunt_conductance: 0, to_shunt_susceptance: 0,
    };
    case 'generator': return {
      gen_id: g('f_gen_id'), gen_bus_id: g('f_gen_bus_id'), gen_name: g('f_gen_name'),
      gen_status: g('f_gen_status'), p_gen: g('f_p_gen'), q_gen: g('f_q_gen'),
      v_setpoint: g('f_v_setpoint'), p_min: g('f_p_min'), p_max: g('f_p_max'),
      q_min: g('f_q_min'), q_max: g('f_q_max'),
    };
    case 'load': return {
      load_id: g('f_load_id'), bus_id: g('f_bus_id'), load_name: g('f_load_name'),
      real_load: g('f_real_load'), imag_load: g('f_imag_load'),
    };
    default: return {};
  }
}

async function saveModal() {
  if (!modalMode) return;
  const { type, id, add } = modalMode;
  const body = collectForm(type);

  const plural = { bus: 'buses', branch: 'branches', generator: 'generators', load: 'loads' }[type];
  const idField = { bus: 'bus_id', branch: 'id', generator: 'gen_id', load: 'load_id' }[type];

  let r;
  if (add) {
    r = await api('POST', `/api/${plural}`, body);
  } else {
    r = await api('PUT', `/api/${plural}/${id}`, body);
  }

  if (r.ok) {
    closeModal();
    await refreshNetwork();
    toast(add ? `${type} added` : `${type} updated`);
  } else {
    toast(r.data.error || 'Save failed', 'err');
  }
}

// ─── Init ────────────────────────────────────────────────────────────────────

(async () => {
  const r = await api('GET', '/api/network');
  if (r.ok) {
    state = r.data;
    updateCaseInfo();
    renderContent();
  }
})();
</script>
</body>
</html>
